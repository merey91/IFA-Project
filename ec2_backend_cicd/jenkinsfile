pipeline {
  agent any

  environment {
    ENV_FILE = credentials('ifa-env-file') // æ³¨å…¥ .env æ–‡ä»¶ï¼ˆéšè—ï¼‰
  }

  stages {
    stage('Install') {
      steps {
        dir('translator-api') {
          echo 'ðŸ“¦ æ­£åœ¨å®‰è£…ä¾èµ–...'
          sh 'npm install'
        }
      }
    }

    stage('Deploy to EC2') {
      steps {
        sshagent(credentials: ['ifa-ec2-key']) {
          sh '''
            echo "ðŸš€ æ­£åœ¨å°† .env åŒæ­¥åˆ° EC2..."
            scp -o StrictHostKeyChecking=no "$ENV_FILE" ec2-user@54.227.29.184:~/translator-api/.env

            echo "ðŸ”§ æ­£åœ¨è¿žæŽ¥ EC2 æ‰§è¡Œéƒ¨ç½²å‘½ä»¤..."

            ssh -o StrictHostKeyChecking=no ec2-user@54.227.29.184 "
              cd ~/translator-api &&
              echo ðŸ“¦ æ‹‰å–æœ€æ–°ä»£ç ... &&
              git pull origin devops-Rocky &&
              echo ðŸ“¦ å®‰è£…ä¾èµ–... &&
              npm install &&
              echo ðŸš€ è¿è¡Œ npm run devï¼ˆåŽå°ï¼‰...
              nohup npm run dev > dev.log 2>&1 &
            "
          '''
        }
      }
    }

    post {
        success {
            echo "Deployment to ${params.ENVIRONMENT} was successful!"
        }
        failure {
            echo "Deployment to ${params.ENVIRONMENT} failed!"
        }
    }
}
  }
}
        
